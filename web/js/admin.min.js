/* KhayCake by TheB1ackSheep, Front-End Developer 2015-04-30 */
var A;$(document).ready(function(){var a=$(".app-loading-mask");var b="http://jsp.falook.me/khaycake";var c=$(".app-content .action-bar");var d=$(".app-content .content");var e={},f=null;var g;var h=h||{xhr:[],isAjax:false,onHashChanged:function(){var a=window.location.hash.substr(2);var b=a.split("/")[1];var c=a.split("/")[2];var d=a.split("/")[3];switch(b){case"cakes":if(c%1===0){this.loadCakeById(c)}else{if(c=="add")this.loadCakeAddForm();else if(c=="all")this.loadCakeIndex(true);else if(c=="search"){if(d){this.loadCakeIndex(d)}}else this.loadCakeIndex()}break;case"customers":break;default:b="dashboard";break}$(".app-nav a").removeClass("active");$(".app-nav a#"+b).addClass("active")},loadingMask:function(){a.html("<span class='loader'><span class='loader-inner'></span></span>");a.addClass("show")},loadedMask:function(){a.html("");a.removeClass("show")},toMoney:function(a){return a.toFixed(2).replace(/\d(?=(\d{3})+\.)/g,"$&,")},showInfo:function(){if(e.error){var a='<div class="alert alert-danger" role="alert">';for(var b in e.message)a+=e.message[b]+"<br/>";a+="</div>";$("#error").html(a)}if(f){var a='<div class="alert alert-info" role="alert">'+f+"</dov>";$("#message").html(a)}},clearInfo:function(){$("#error").html("");$("#message").html("");e=[];f=null},cancleAllRequest:function(){for(var a in h.xhr)if(h.xhr[a].abort){h.xhr[a].abort();h.xhr.splice(a,1)}},url:function(a){var c=a.split("?");if(c.length>1){a=c[0]}return b+a+(g?";jsessionid="+g:"")+(c[1]?"?"+c[1]:"")},get:function(a,b,c){if(c)h.cancleAllRequest();h.loadingMask();h.clearInfo();var d=$.ajax({type:"GET",url:h.url(a),success:function(a){if(typeof b==="function")b(a);if(a.JSESSIONID)g=a.sessionId;h.loadedMask();h.showInfo()},error:function(a){e="มีบางอย่างไม่ถูกต้อง";h.loadedMask();h.showInfo()}});h.xhr.push(d)},post:function(a,b,c){h.cancleAllRequest();h.loadingMask();h.clearInfo();var d=$.ajax({type:"POST",url:h.url(a),data:b,success:function(a){if(typeof c==="function")c(a);if(a.JSESSIONID)g=a.sessionId;h.loadedMask();h.showInfo()},error:function(a){e="มีบางอย่างไม่ถูกต้อง";h.loadedMask();h.showInfo()}});h.xhr.push(d)},upload:function(a,b,c,d){var e=$.ajax({type:"POST",url:h.url(a),data:b,cache:false,processData:false,contentType:false,success:function(a){if(typeof c==="function")c(a);if(a.JSESSIONID)g=a.sessionId;h.showInfo()},error:function(a){if(typeof d==="function")d(a);h.showInfo()}});h.xhr.push(e)},cakeForm:function(a){return'<div id="error"></div><div id="message"></div>'+'<div class="small-padding">'+'<form action="POST" id="form-cake">'+'<div class="row">'+'<div class="col-md-6" style="max-width: 400px">'+'<h3 class="title">'+a+"</h3>"+'<p class="subtitle">เพิ่มเค้กใหม่ลงหน้าร้าน</p>'+'<div class="form-group">'+'<label for="name">ชื่อเค้ก</label><input class="form-control" id="name" name="name" placeholder="คัพเค้กหน้าเป็ด, เค้กปาร์ตี้วันเกิด">'+"</div>"+'<div class="form-group">'+'<label>รายละเอียด</label><textarea rows="5" class="form-control" name="detail" id="detail"></textarea>'+"</div>"+'<div class="form-group">'+'   <label for="pictures">รูปภาพ</label><div id="pic-list"></div><input type="file" accept="image/*" multiple name="pictures" id="pictures"/>'+"</div>"+'<div class="form-group">'+'<div class="row">'+'<div class="col-sm-6">'+'<label>หน่วยนับ</label><div id="unit-container"></div>'+"</div>"+'<div class="col-sm-6">'+"<label>ชนิด</label>"+'<div id="category-container"></div>'+"</div>"+"</div>"+"</div>"+'<div class="form-group">'+'<div class="row">'+'<div class="col-sm-6">'+'<label>ต้นทุน (บาท)</label><div class="input-group"><span class="input-group-addon">&#3647;</span><input type="number" id="cost" name="cost" class="form-control"/></div>'+"</div>"+'<div class="col-sm-6">'+'<label>ราคาขายต่อหน่วย (บาท)</label><div class="input-group"><span class="input-group-addon">&#3647;</span><input type="number" id="price" name="price" class="form-control"/></div>'+"</div>"+"</div>"+"</div>"+"</div>"+'<div class="col-md-6" style="max-width: 400px">'+'<h3 class="title">ราคาพิเศษ</h3>'+'<p class="subtitle">ราคาขายเมื่อลูกค้าซื้อตามจำนวนที่กำหนด</p>'+'<div class="row" id="product_sale"></div>'+'<div class="form-group">'+'<label>&nbsp;</label><button class="btn btn-default form-control" id="add-sale">เพิ่มราคาพิเศษ</button>'+"</div>"+"</div>"+"</div>"+"</form>"+"</div>"},cakeSaleForm:function(a){if(!a){a={sale:{}}}return'<div class="form-group"><div class="col-md-4">'+'<div class="form-group">'+'<label>จำนวนชิ้น</label><input type="number" name="qty_sale" class="form-control" value="'+(a.qty?a.qty:"")+'"/>'+"</div>"+"</div>"+'<div class="col-md-6">'+'<div class="form-group">'+"<label>ราคาขาย (บาท)</label>"+'<div class="input-group"><span class="input-group-addon">&#3647;</span><input type="number" name="price_sale" class="form-control" value="'+(a.price?a.price:"")+'"/></div>'+'</div></div><div class="col-md-2"><div class="form-group"><label>&nbsp;</label>'+"<a "+(a.id?'id="sale-'+a.id+'"':"")+' class="btn btn-default form-control"><span class="glyphicon glyphicon-trash"></span></a></div></div>'},loadCakeIndex:function(a){if(a){if(a===true){a="all"}else a="q="+a}c.html('<div class="el"><button class="btn btn-default" id="refresh-cake">รีเฟรช</button></div><div class="el btn-group"><a href="#!/cakes/add" class="btn btn-primary" id="add-cake">เพิ่มเค้ก</a><button class="btn btn-danger disabled" id="delete-cake">ลบ</button></div><div class="el"><form id="form-search-cake"><div class="input-group" style="max-width: 400px"><input type="text" name="q" id="keyword" class="form-control" placeholder="ค้นหาตามชื่อเค้ก, คำอธิบาย" required><span class="input-group-btn"><button class="btn btn-default" id="search-cake" type="submit">ค้นหา</button></span></div></form></div>');$("#refresh-cake").click(function(){h.onHashChanged()});$("#form-search-cake").submit(function(a){a.preventDefault();window.location.hash="#!/cakes/search/"+$("#form-search-cake #keyword").val();return false});h.get("/product"+(a?"?"+a:""),function(b){if(!b.error){var c='<div id="error"></div><div id="message"></div><form id="form-cake"><table class="p6n-table">'+"<tbody>"+"<tr>"+'<th style="width:13px">'+'<label class="ng-isolate-scope p6n-checkbox">'+'<input type="checkbox" class="ng-valid ng-scope ng-dirty ng-valid-parse ng-touched">'+"</label>"+"</th>"+'<th class="p6n-acl-header-name">'+'<a href="javascript:;" class="p6n-clickable-link p6n-sort-link">ชื่อเค้ก</a>'+"</th>"+'<th class="p6n-acl-header-name" >'+'<a href="javascript:;" class="p6n-clickable-link p6n-sort-link p6n-sort-flip">ชนิด</a>'+"</th>"+'<th class="p6n-acl-header-name text-right">'+'<a href="javascript:;" class="p6n-clickable-link p6n-sort-link p6n-sort-flip">ต้นทุน (บาท)</a>'+"</th>"+'<th class="p6n-acl-header-name text-right">'+'<a href="javascript:;" class="p6n-clickable-link p6n-sort-link p6n-sort-flip">ขาย (บาท)</a>'+"</th>"+"</tr>";if(b.ProductList){for(var d in b.message.ProductList){var g=b.message.ProductList[d];c+="<tr>"+"<td>"+'<label class="ng-isolate-scope p6n-checkbox">'+'<input type="checkbox"  name="p_id" value="'+g.id+'" class="ng-valid ng-scope ng-dirty ng-valid-parse ng-touched">'+"</label>"+"</td>"+'<td><a href="#!/cakes/'+g.id+'">'+g.name+"</a></td>"+"<td>"+g.category.name+"</td>"+'<td class="text-right">'+h.toMoney(g.cost)+"</td>"+'<td class="text-right">'+h.toMoney(g.price)+"</td>"+"</tr>"}}else{c+='<tr><td colspan="5">ไม่พบเค้กใด ๆ ในระบบ</td></tr>'}c+="</table></form>";if(a!="all")c+='<a href="#!/cakes/all">ดูเต้กทั้งหมด</a>';$(".content").html(c);$("#delete-cake").click(function(){h.post("/product/delete",$("#form-cake").serialize(),function(a){if(!a.error){f="ลบเค้กที่เลือกไว้เรียบร้อย";$("input[type=checkbox]:checked").parent().parent().parent().remove()}else e=a})});$("input[type=checkbox]").on("change",function(a){var b=$("input[type=checkbox]:checked").length;if(b>0)$("#delete-cake").removeClass("disabled");else $("#delete-cake").addClass("disabled")})}},true)},loadCakeAddForm:function(){c.html('<div class="el"><a href="#!/cakes" class="btn btn-default">กลับ</a></div><div class="el"><button class="btn btn-primary" id="add-cake">บันทึก</button></div>');d.html(h.cakeForm("เพิ่มเค้ก"));$("#add-sale").click(function(a){a.preventDefault();var b=$("#product_sale");var c=$("#product_sale>div").length;if(c<5){$(b).append(h.cakeSaleForm());$("#product_sale>div a").click(function(){$(this).parent().parent().parent().remove()})}return false});$("#add-cake").click(function(){$("#form-cake").submit()});$("#form-cake").submit(function(){h.post("/product",$("#form-cake").serialize(),function(a){if(!a.error){window.location.hash="#!/cakes";f="เพิ่ม "+a.message.name+" เรียบร้อย"}else{e=a}console.log(a)});return false});$("#form-cake #pictures").on("change",function(a){var b=a.target.files;var c=new FormData;$.each(b,function(a,b){c.append("pictures",b)});h.upload("/picture",c,function(a){if(!a.error){if(a.PictureList){var b="";for(var c in a.PictureList){var d=a.PictureList[c];b+='<div class="filename alert-dismissible" role="alert">'+d.filename+'</div><input type="hidden" name="pic_id" value="'+d.id+'"/>'}$("#form-cake #pic-list").html(b)}}})});var a=$("#category-container");var b=$("#unit-container");h.get("/category",function(b){if(!b.error){if(b.CategoryList){var c='<select class="form-control" id="category" name="category">"';for(var d in b.CategoryList){var e=b.CategoryList[d];c+='<option value="'+e.id+'">'+e.name+"</option>"}c+="</select>";a.html(c)}}});h.get("/unit",function(a){if(!a.error){if(a.UnitList){var c='<select class="form-control" id="unit" name="unit">"';for(var d in a.UnitList){var e=a.UnitList[d];c+='<option value="'+e.id+'">'+e.name+"</option>"}c+="</select>";b.html(c)}}})},loadCakeById:function(a){h.get("/product/"+a,function(b){if(!b.error&&b.Product){c.html('<div class="el"><a href="#!/cakes" class="btn btn-default">กลับ</a></div><div class="el"><button class="btn btn-primary" id="add-cake">บันทึก</button></div>');d.html(h.cakeForm("แก้ไขเค้ก"));$("#add-sale").click(function(a){a.preventDefault();var b=$("#product_sale");var c=$("#product_sale>div").length;if(c<5){$(b).append(h.cakeSaleForm());$("#product_sale>div a").click(function(){$(this).parent().parent().parent().remove()})}return false});$("#form-cake #pictures").on("change",function(a){var b=a.target.files;var c=new FormData;$.each(b,function(a,b){c.append("pictures",b)});h.upload("/picture",c,function(a){if(!a.error){if(a.PictureList){var b="";for(var c in a.PictureList){var d=a.PictureList[c];b+='<div class="filename alert-dismissible" role="alert">'+d.filename+'</div><input type="hidden" name="pic_id" value="'+d.id+'"/>'}$("#form-cake #pic-list").html(b)}}})});var g=$("#category-container");var i=$("#unit-container");h.get("/category",function(a){if(!a.error){if(a.CategoryList){var b='<select class="form-control" id="category" name="category">"';for(var c in a.CategoryList){var d=a.CategoryList[c];b+='<option value="'+d.id+'">'+d.name+"</option>"}b+="</select>";g.html(b)}}});h.get("/unit",function(a){if(!a.error){if(a.UnitList){var b='<select class="form-control" id="unit" name="unit">"';for(var c in a.UnitList){var d=a.UnitList[c];b+='<option value="'+d.id+'">'+d.name+"</option>"}b+="</select>";i.html(b)}}});$("#add-cake").click(function(){$("#form-cake").submit()});$("#form-cake").submit(function(){h.post("/product/"+a,$("#form-cake").serialize(),function(a){if(!a.error){window.location.hash="#!/cakes";f="แก้ไข "+a.name+" เรียบร้อย"}else{e=a}console.log(a)});return false});var j=b.Product;$("#form-cake #name").val(j.name);$("#form-cake #detail").val(j.detail);$("#form-cake #unit").val(j.unit.id);$("#form-cake #category").val(j.category.id);$("#form-cake #cost").val(j.cost);$("#form-cake #price").val(j.price);if(j.pictures)for(var k in j.pictures){var l=j.pictures[k];$("#form-cake #pic-list").html('<div class="filename alert-dismissible" role="alert">'+l.filename+'</div><input type="hidden" name="pic_id" value="'+l.id+'"/>')}if(j.sales){for(var k in j.sales){var m=j.sales[k];$("#form-cake #product_sale").append(h.cakeSaleForm(m));$("#product_sale>div a").click(function(){$(this).parent().parent().parent().remove()})}}}},false)}};A=h;$(window).bind("hashchange",function(){h.onHashChanged()});if(window.location.hash){h.onHashChanged()}});