/* KhayCake by TheB1ackSheep, Front-End Developer 2015-05-04 */
$(document).ready(function(){var a=$(".app-loading-mask");var b="http://jsp.falook.me/khaycake";var c=$(".app-content .action-bar");var d=$(".app-content .content");var e=$(".app-content .message");var f={},g=null;var h;Ajax.onError=function(a){var b="";if(!a.responseText&&a.error){if(a.error.length>0){for(var c in a.error.message)f+=a.error.message[c]+"<br/>"}else{b+=a.message}}else{b+="request return with status "+a.status+" : "+a.statusText}alert(b);i.loadedMask()};var i=i||{xhr:[],isAjax:false,loadingMask:function(){a.html("<span class='loader'><span class='loader-inner'></span></span>");a.addClass("show")},loadedMask:function(){a.html("");a.removeClass("show")},toMoney:function(a){return a.toFixed(2).replace(/\d(?=(\d{3})+\.)/g,"$&,")},loadCakeIndex:function(a){},loadCakeAddForm:function(){$("#add-cake").click(function(){$("#form-cake").submit()});$("#form-cake").submit(function(){i.post("/product",$("#form-cake").serialize(),function(a){if(!a.error){window.location.hash="#!/cakes";g="เพิ่ม "+a.message.name+" เรียบร้อย"}else{f=a}console.log(a)});return false});var a=$("#category-container");var b=$("#unit-container");i.get("/category",function(b){if(!b.error){if(b.CategoryList){var c='<select class="form-control" id="category" name="category">"';for(var d in b.CategoryList){var e=b.CategoryList[d];c+='<option value="'+e.id+'">'+e.name+"</option>"}c+="</select>";a.html(c)}}});i.get("/unit",function(a){if(!a.error){if(a.UnitList){var c='<select class="form-control" id="unit" name="unit">"';for(var d in a.UnitList){var e=a.UnitList[d];c+='<option value="'+e.id+'">'+e.name+"</option>"}c+="</select>";b.html(c)}}})},loadCakeById:function(a){i.get("/product/"+a,function(b){console.log(b);if(b.success&&b.message){c.html('<div class="el"><a href="#!/cakes" class="btn btn-default">กลับ</a></div><div class="el"><button class="btn btn-primary" id="add-cake">บันทึก</button></div>');d.html(i.cakeForm("แก้ไขเค้ก"));$("#add-sale").click(function(a){a.preventDefault();var b=$("#product_sale");var c=$("#product_sale>div").length;if(c<5){$(b).append(i.cakeSaleForm());$("#product_sale>div a").click(function(){$(this).parent().parent().parent().remove()})}return false});$("#form-cake #pictures").on("change",function(a){var b=a.target.files;var c=new FormData;$.each(b,function(a,b){c.append("pictures",b)});i.upload("/picture",c,function(a){if(!a.error){if(a.PictureList){var b="";for(var c in a.PictureList){var d=a.PictureList[c];b+='<div class="filename alert-dismissible" role="alert">'+d.filename+'</div><input type="hidden" name="pic_id" value="'+d.id+'"/>'}$("#form-cake #pic-list").html(b)}}})});var e=$("#category-container");var h=$("#unit-container");i.get("/category",function(a){if(!a.error){if(a.CategoryList){var b='<select class="form-control" id="category" name="category">"';for(var c in a.CategoryList){var d=a.CategoryList[c];b+='<option value="'+d.id+'">'+d.name+"</option>"}b+="</select>";e.html(b)}}});i.get("/unit",function(a){if(!a.error){if(a.UnitList){var b='<select class="form-control" id="unit" name="unit">"';for(var c in a.UnitList){var d=a.UnitList[c];b+='<option value="'+d.id+'">'+d.name+"</option>"}b+="</select>";h.html(b)}}});$("#add-cake").click(function(){$("#form-cake").submit()});$("#form-cake").submit(function(){i.post("/product/"+a,$("#form-cake").serialize(),function(a){if(!a.error){window.location.hash="#!/cakes";g="แก้ไข "+a.name+" เรียบร้อย"}else{f=a}console.log(a)});return false});var j=b.message;$("#form-cake #name").val(j.name);$("#form-cake #detail").val(j.detail);$("#form-cake #unit").val(j.unit.id);$("#form-cake #category").val(j.category.id);$("#form-cake #cost").val(j.cost);$("#form-cake #price").val(j.price);if(j.pictures)for(var k in j.pictures){var l=j.pictures[k];$("#form-cake #pic-list").html('<div class="filename alert-dismissible" role="alert">'+l.filename+'</div><input type="hidden" name="pic_id" value="'+l.id+'"/>')}if(j.sales){for(var k in j.sales){var m=j.sales[k];$("#form-cake #product_sale").append(i.cakeSaleForm(m));$("#product_sale>div a").click(function(){$(this).parent().parent().parent().remove()})}}}},false)}};i.onHashChanged=function(){var a=window.location.hash.substr(2);var b=a.split("/")[1];var c=a.split("/")[2];var d=a.split("/")[3];switch(b){case"cakes":i.tabCake();break;case"customers":i.tabCustomer();break;default:b="dashboard";i.tabDashBoard();break}$(".app-nav a").removeClass("active");$(".app-nav a#"+b).addClass("active")};i.tabCake=function(){var a='<div class="el"><button class="btn btn-default" id="refresh-cake">รีเฟรช</button></div><div class="el btn-group"><a href="#!/cakes/create" class="btn btn-primary" id="add-cake">เพิ่มเค้ก</a><button class="btn btn-danger disabled" id="delete-cake">ลบ</button></div><div class="el"><form id="form-search-cake"><div class="input-group" style="max-width: 400px"><input type="text" name="q" id="keyword" class="form-control" placeholder="ค้นหาตามชื่อเค้ก, คำอธิบาย" required><span class="input-group-btn"><button class="btn btn-default" id="search-cake" type="submit">ค้นหา</button></span></div></form></div>';var b=window.location.hash.substr(2);var e=b.split("/");var f,g;if(e){if(e.length>=3)f=e[2];if(e.length>=4)g=e[3]}if(!f){i.loadingMask();Product.all(function(b){$(c).html(a);i.tabCake.table(b.message);i.tabCake.bind();i.loadedMask()})}else if(f){if(isInteger(f)){i.loadingMask();Product.find(f,function(b){var e=b.message;a='<div class="el"><a href="#!/cakes" class="btn btn-default">กลับ</a></div><div class="el"><button class="btn btn-primary" id="update-cake">บันทึก</button></div>';$(c).html(a);$(d).html(Product.form("แก้ไขเค้กใหม่",e));Unit.box(function(a){$("#unit-container").html(a);$("#unit-container select").val(e.unit.id)});Category.box(function(a){$("#category-container").html(a);$("#category-container select").val(e.category.id)});Product.pictures(f,function(a){var b="";for(var c in a.message){var d=a.message[c];b+=Product.form.picture(d)}$("#form-cake #pic-list").html(b)});Product.sales(f,function(a){var b="";for(var c in a.message){var d=a.message[c];b+=Product.form.sale(d)}$("#form-cake #product_sale").html(b)});i.tabCake.bind(f);i.loadedMask()})}else{if(f==="create"){a='<div class="el"><a href="#!/cakes" class="btn btn-default">กลับ</a></div><div class="el"><button class="btn btn-primary" id="save-cake">บันทึก</button></div>';$(c).html(a);$(d).html(Product.form("เพิ่มเค้กใหม่"));Unit.box(function(a){$("#unit-container").html(a)});Category.box(function(a){$("#category-container").html(a)});i.tabCake.bind()}else if(f==="search"){Product.find(g,function(b){a='<div class="el"><a href="#!/cakes" class="btn btn-default">กลับ</a></div><div class="el btn-group"><a href="#!/cakes/create" class="btn btn-primary" id="add-cake">เพิ่มเค้ก</a><button class="btn btn-danger disabled" id="delete-cake">ลบ</button></div><div class="el"><form id="form-search-cake"><div class="input-group" style="max-width: 400px"><input type="text" name="q" id="keyword" class="form-control" placeholder="ค้นหาตามชื่อเค้ก, คำอธิบาย" required><span class="input-group-btn"><button class="btn btn-default" id="search-cake" type="submit">ค้นหา</button></span></div></form></div>';$(c).html(a);$("#form-search-cake #keyword").val(g);i.tabCake.table(b.message);i.tabCake.bind();i.loadedMask()})}}}};i.tabCake.table=function(a){var b='<div id="error"></div><div id="message"></div><form id="form-cake"><table class="p6n-table">'+"<tbody>"+"<tr>"+'<th style="width:13px">'+'<label class="ng-isolate-scope p6n-checkbox">'+'<input type="checkbox" class="ng-valid ng-scope ng-dirty ng-valid-parse ng-touched">'+"</label>"+"</th>"+'<th class="p6n-acl-header-name">'+'<a href="javascript:;" class="p6n-clickable-link p6n-sort-link">ชื่อเค้ก</a>'+"</th>"+'<th class="p6n-acl-header-name" >'+'<a href="javascript:;" class="p6n-clickable-link p6n-sort-link p6n-sort-flip">ชนิด</a>'+"</th>"+'<th class="p6n-acl-header-name text-right">'+'<a href="javascript:;" class="p6n-clickable-link p6n-sort-link p6n-sort-flip">ต้นทุน (บาท)</a>'+"</th>"+'<th class="p6n-acl-header-name text-right">'+'<a href="javascript:;" class="p6n-clickable-link p6n-sort-link p6n-sort-flip">ขาย (บาท)</a>'+"</th>"+"</tr>";if(a&&a.length>0){for(var c in a){var e=a[c];b+="<tr>"+"<td>"+'<label class="ng-isolate-scope p6n-checkbox">'+'<input type="checkbox"  name="p_id" value="'+e.id+'" class="ng-valid ng-scope ng-dirty ng-valid-parse ng-touched">'+"</label>"+"</td>"+'<td><a href="#!/cakes/'+e.id+'">'+e.name+"</a></td>"+"<td>"+e.category.name+"</td>"+'<td class="text-right">'+i.toMoney(e.cost)+"</td>"+'<td class="text-right">'+i.toMoney(e.price)+"</td>"+"</tr>"}}else{b+='<tr><td colspan="5">ไม่มีเค้กใด ๆ ในระบบ</td></tr>'}b+="</table>";$(d).html(b)};i.tabCake.bind=function(a){$("input[type=checkbox]").on("change",function(a){var b=$("#form-cake").serializeArray();if(b&&b.length>0)$("#delete-cake").removeClass("disabled");else $("#delete-cake").addClass("disabled")});$("#refresh-cake").click(function(){i.onHashChanged()});$("#form-search-cake").submit(function(a){window.location.hash="#!/cakes/search/"+$("#form-search-cake #keyword").val();return false});$("#form-cake #add-sale").click(function(a){var b=$("#product_sale");var c=$("#product_sale>div").length;if(c<5){$(b).append(Product.form.sale());$("#product_sale>div a").click(function(){$(this).parent().parent().parent().remove()})}return false});$(".action-bar #save-cake").click(function(a){i.loadingMask();Product.save($("#form-cake"),function(a){i.loadedMask();alert("เพิ่มข้อมูลเรียบร้อย");window.location.hash="#!/cakes"})});$(".action-bar #update-cake").click(function(b){i.loadingMask();Product.update(a,$("#form-cake"),function(a){i.loadedMask();alert("แก้ไขข้อมูลเรียบร้อย");window.location.hash="#!/cakes"})});$(".action-bar #delete-cake").click(function(){var a=$("#form-cake").serializeArray();if(a&&a.length>0){i.loadingMask();var b=a.length;var c=0;for(var d in a){Product.delete(a[d].value,function(){i.loadedMask();if(++c==b){alert("ลบข้อมูลเรียบร้อย");i.onHashChanged()}})}}});$("#form-cake #pictures").on("change",function(a){$("#form-cake #pic-list").html("<p>กำลังอัพโหลดไฟล์...</p>");var b=a.target.files;var c=new FormData;$.each(b,function(a,b){c.append("pictures",b)});Ajax.UPLOAD("/picture",c,function(a){if(a.message){var b="";for(var c in a.message){var d=a.message[c];b+=Product.form.picture(d)}$("#form-cake #pic-list").html(b)}})})};$(window).bind("hashchange",function(){i.onHashChanged()});if(window.location.hash){i.onHashChanged()}});